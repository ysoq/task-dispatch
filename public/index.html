<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>终端任务调度系统</title>
  <!-- 引入Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- 引入Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      margin-bottom: 20px;
    }
    #messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      background-color: #f9f9f9;
    }
    .message {
      margin-bottom: 10px;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
    .terminal-table th, .terminal-table td {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>终端任务调度系统</h1>

  <div class="container border rounded p-4 shadow-sm">
    <h2 class="text-primary mb-3"><i class="fas fa-plug"></i> WebSocket连接状态</h2>
    <div id="connectionStatus" class="fs-5 font-medium">未连接</div>
  </div>

  <div class="container border rounded p-4 shadow-sm">
    <h2 class="text-primary mb-3"><i class="fas fa-tasks"></i> 任务下发</h2>

    <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h6">终端列表</h3>
        <button id="refreshTerminalsBtn" class="btn btn-secondary btn-sm"><i class="fas fa-sync-alt"></i> 刷新</button>
      </div>

      <div class="overflow-x-auto">
        <table class="table table-striped terminal-table" id="terminalTable">
          <thead>
            <tr>
              <th>选择</th>
              <th>终端ID</th>
              <th>类型</th>
              <th>状态</th>
            </tr>
          </thead>
          <tbody id="terminalTableBody">
            <tr>
              <td colspan="4" class="text-center">加载中...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mb-3 p-3 bg-info bg-opacity-10 rounded border border-info mt-3">
        <h4 class="h6 mb-2 text-info"><i class="fas fa-terminal"></i> 当前选择的终端</h4>
        <div id="selectedTerminalInfo" class="font-medium">未选择终端</div>
      </div>
    </div>

    <div class="mb-3">
      <label for="actionInput" class="form-label">操作类型 (Action):</label>
      <input type="text" id="actionInput" class="form-control" placeholder="输入操作类型" value="process">
    </div>
    <div class="mb-3">
      <label for="dataInput" class="form-label">任务数据 (Data):</label>
      <input type="text" id="dataInput" class="form-control" placeholder="输入任务数据" value="示例任务数据">
    </div>

    <button id="submitTaskBtn" class="btn btn-success w-100"><i class="fas fa-paper-plane"></i> 下发任务到指定终端</button>
  </div>

  <div class="container border rounded p-4 shadow-sm">
    <h2 class="text-primary mb-3"><i class="fas fa-history"></i> 消息日志</h2>
    <div id="messages" class="border rounded p-3 bg-light"></div>
  </div>

  <!-- 引入Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <script>
    // WebSocket连接
    let socket;
    const messagesDiv = document.getElementById('messages');
    const connectionStatus = document.getElementById('connectionStatus');

    // 连接WebSocket服务器
    function connectWebSocket() {
      // 关闭任何现有的连接
      if (socket) {
        socket.close();
      }

      // 创建新连接
      const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      const wsUrl = wsProtocol + window.location.host + '/ws';
      socket = new WebSocket(wsUrl);

      // 连接打开时
      socket.onopen = () => {
        connectionStatus.textContent = '已连接';
        connectionStatus.style.color = 'green';
        addMessage('WebSocket连接已建立');
      };

      // 接收消息时
      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (error) {
          addMessage('接收到无效消息: ' + event.data, 'error');
        }
      };

      // 连接关闭时
      socket.onclose = () => {
        connectionStatus.textContent = '已断开';
        connectionStatus.style.color = 'red';
        addMessage('WebSocket连接已关闭');

        // 尝试重连
        setTimeout(connectWebSocket, 3000);
      };

      // 连接出错时
      socket.onerror = (error) => {
        addMessage('WebSocket错误: ' + error, 'error');
      };
    }

    // 处理接收到的消息
    function handleMessage(data) {
      switch (data.type) {
        case 'welcome':
          addMessage('服务器: ' + data.message, 'success');
          break;
        case 'task_assigned':
          addMessage(`任务已分配到终端 ${data.terminalId}: ${data.taskId}`, 'success');
          break;
        case 'error':
          addMessage('错误: ' + data.message, 'error');
          break;
        default:
          addMessage('未知消息类型: ' + JSON.stringify(data));
      }
    }

    // 添加消息到日志
    function addMessage(text, type = '') {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message' + (type ? ' ' + type : '');
      messageDiv.textContent = new Date().toLocaleTimeString() + ': ' + text;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 发送消息到服务器
    function sendMessage(message) {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify(message));
      } else {
        addMessage('WebSocket未连接，无法发送消息', 'error');
      }
    }

    // 获取终端列表
    function getTerminalList() {
      fetch('/api/terminal/')
        .then(response => response.json())
        .then(terminals => {
          const tableBody = document.getElementById('terminalTableBody');
          tableBody.innerHTML = '';

          if (terminals.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">无可用终端</td></tr>';
            return;
          }

          terminals.forEach(terminal => {
            const row = document.createElement('tr');
            row.dataset.terminalId = terminal.id;
            row.addEventListener('click', () => selectTerminalRow(row));

            // 设置状态样式
            let statusClass = '';
            if (terminal.status === 'online') {
              statusClass = 'text-success';
            } else if (terminal.status === 'offline') {
              statusClass = 'text-danger';
            } else {
              statusClass = 'text-warning';
            }

            row.innerHTML = `
              <td><input type="radio" name="terminalSelect" value="${terminal.id}"></td>
              <td>${terminal.id}</td>
              <td>${terminal.type}</td>
              <td class="${statusClass}">${terminal.status}</td>
            `;

            tableBody.appendChild(row);
          });
        })
        .catch(error => {
          addMessage('获取终端列表失败: ' + error.message, 'error');
          document.getElementById('terminalTableBody').innerHTML = '<tr><td colspan="4" class="text-center text-danger">获取失败</td></tr>';
        });
    }

    // 选择终端行
    function selectTerminalRow(selectedRow) {
      // 移除其他行的选中状态
      document.querySelectorAll('#terminalTableBody tr').forEach(row => {
        row.classList.remove('table-primary');
      });

      // 添加当前行的选中状态
      selectedRow.classList.add('table-primary');

      // 选中对应的radio
      const radio = selectedRow.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        // 更新选中终端信息
        updateSelectedTerminalInfo(radio.value);
      }
    }

    // 更新选中终端信息
    function updateSelectedTerminalInfo(terminalId) {
      fetch(`/api/terminal/${terminalId}`)
        .then(response => response.json())
        .then(terminal => {
          const infoDiv = document.getElementById('selectedTerminalInfo');
          let statusClass = '';
          if (terminal.status === 'online') {
            statusClass = 'text-success';
          } else if (terminal.status === 'offline') {
            statusClass = 'text-danger';
          } else {
            statusClass = 'text-warning';
          }
          // 构建元数据HTML
          let metadataHtml = '<div><strong>元数据:</strong> ';
          if (terminal.metadata && Object.keys(terminal.metadata).length > 0) {
            metadataHtml += '<ul class="list-unstyled mt-1 mb-0">';
            for (const [key, value] of Object.entries(terminal.metadata)) {
              metadataHtml += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            metadataHtml += '</ul>';
          } else {
            metadataHtml += '无元数据';
          }
          metadataHtml += '</div>';

          infoDiv.innerHTML = `
            <div><strong>终端ID:</strong> ${terminal.id}</div>
            <div><strong>类型:</strong> ${terminal.type}</div>
            <div><strong>状态:</strong> <span class="${statusClass}">${terminal.status}</span></div>
            ${metadataHtml}
          `;
        })
        .catch(error => {
          document.getElementById('selectedTerminalInfo').innerHTML = `获取终端信息失败: ${error.message}`;
        });
    }

    // 刷新终端列表按钮事件
    document.getElementById('refreshTerminalsBtn').addEventListener('click', () => {
      document.getElementById('terminalTableBody').innerHTML = '<tr><td colspan="4" class="text-center">加载中...</td></tr>';
      getTerminalList();
    });

    // 提交任务到指定终端
    document.getElementById('submitTaskBtn').addEventListener('click', () => {
      try {
        const selectedRadio = document.querySelector('input[name="terminalSelect"]:checked');
        if (!selectedRadio) {
          addMessage('请选择终端', 'error');
          return;
        }

        const terminalId = selectedRadio.value;
        const action = document.getElementById('actionInput').value;
        const data = document.getElementById('dataInput').value;
        const taskData = { action, data };

        if (!action || !data) {
          addMessage('操作类型和任务数据不能为空', 'error');
          return;
        }

        // 使用HTTP API提交任务
        fetch(`/api/task/submit?terminalId=${terminalId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.taskId) {
            addMessage(`任务提交成功，任务ID: ${data.taskId}`, 'success');
          } else {
            addMessage(`任务提交失败: ${data.message}`, 'error');
          }
        })
        .catch(error => {
          addMessage(`任务提交错误: ${error.message}`, 'error');
        });
      } catch (error) {
        addMessage(`任务数据格式错误: ${error.message}`, 'error');
      }
    });

    // 初始连接和获取终端列表
    connectWebSocket();
    // 延迟1秒后获取终端列表，确保WebSocket连接已建立
    setTimeout(getTerminalList, 1000);
  </script>
</body>
</html>